---
title: "Morphea"
author: "Thomas Vroylandt"
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output: 
  html_document:
    css: "../style/style.css"
    includes:
      in_header: "../style/header.html"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

```{r import}
# packages
library(tidyverse)
library(reactable)
library(googlesheets4)
library(htmltools)

# Google Auth
gs4_deauth()

# data
df_tw_sheet <-
  read_sheet(Sys.getenv("SHEET_PATH"),
             sheet = "tw_fav")
```

```{r tab}
# printing functions
# bar chart
bar_chart <-
  function(label,
           width = "100%",
           height = "18px",
           fill = "#00bfc4",
           background = NULL) {
    bar <-
      div(class = "b-chart",
          style = list(
            background = fill,
            width = width,
            height = height
          ))
    label <- div(class = "hideout", format(label, big.mark = " "))
    chart <-
      div(style = list(
        flexGrow = 1,
        marginLeft = "8px",
        background = background
      ),
      bar,
      label)
    div(style = list(display = "flex", alignItems = "center"),
        chart)
  }

# image
print_img <- function(value) {
        if (!is.na(value)) {
          image <- img(src = value)
          tags$a(href = value, target = "_blank", tagList(div(
            style = list(display = "inline-block", width = "100%"), image
          )))
        }
      }

# data
data <- df_tw_sheet %>%
  mutate(
    link_tw = paste0("https://twitter.com/", screen_name, "/status/", status_id),
    text = str_remove_all(text, "http\\S+\\s*")
  ) %>%
  select(link_tw,
         created_at,
         name,
         text,
         media_url,
         hashtags,
         urls_url,
         favorite_count,
         retweet_count)

# table
reactable(
  data,
  filterable = TRUE,
  defaultPageSize = 100,
  defaultColDef = colDef(headerClass = "header"),
  columns = list(
    created_at = colDef(
      name = "Date",
      cell = function(value) {
        format(value, format = "%d/%m/%Y \n%H:%M")
      }
    ),
    name = colDef(name = "Account"),
    text = colDef(name = "Text",
                  minWidth = 300),
    hashtags = colDef(name = "Hashtags", minWidth = 120),
    urls_url = colDef(
      name = "Links",
      cell = function(value) {
        if (!is.na(value)) {
          tags$a(href = value, target = "_blank", as.character(value))
        }
      }
    ),
    link_tw = colDef(
      name = "",
      filterable = FALSE,
      minWidth = 10,
      cell = function(value) {
        tags$a(href = value, target = "_blank", "\u2693")
      }
    ),
    media_url = colDef(
      name = "Media",
      filterable = FALSE,
      cell = print_img,
      minWidth = 150
    ),
    favorite_count = colDef(
      name = "Fav nb.",
      filterable = FALSE,
      cell = function(value) {
        width <-
          paste0(log(value) / log(max(data$favorite_count)) * 100, "%")
        bar_chart(value, width = width, fill = "#741336")
      }
    ),
    retweet_count = colDef(
      name = "Fav RT",
      filterable = FALSE,
      cell = function(value) {
        width <-
          paste0(log(value + 1) / log(max(data$retweet_count)) * 100, "%")
        bar_chart(value, width = width, fill = "#606c71")
      }
    )
  )
)
```

+ https://www.tillac-data.com/
+ https://github.com/tillac/morphea
